#! /bin/sh

#set -x

if [ ! -f /usr/bin/jq ]
then
	# install jq
   apt-get install jq
fi

if [ ! /usr/bin/bc ]
then
	# install bc
   apt-get install bc
fi


while [ true ]
do

EXEDIR=$(dirname $0)


BASEDIR=/mnt/hdd/BTCPAYSERVER
INVOICES=$BASEDIR/invoices
DONEDIR=$BASEDIR/done

install -d $DONEDIR 

if [ ! -x $EXEDIR/doit ]
then
   file $EXEDIR/doit not found
   exit 1 
fi

if [ -f $BASEDIR/conf/payer.conf ]
then
  . $BASEDIR/conf/payer.conf
fi

if [ -z "$PAYER" ]
then
   echo We need a PAYER token
   exit 1
fi

if [ -z "$RATE" ]
then
   echo We need a RATE value
   exit 1
fi

echo Processing files

for i in $INVOICES/*.control 
do
  
   if [ ! -f "$i" ]
   then
      	##echo file $i does not exists
        continue
   fi 

   TOKEN=""
   FILE=""
      
   . $i  
   if [ -z "$TOKEN" ] || [ -z "$FILE" ]
   then
        echo "$i" contains invalid data. Keeping control file and continuing
        continue
   fi

   if [ ! -f "$FILE" ]
   then
        echo $FILE does not exists. Keeping control file and continuing
        continue
   fi

	# wait some time until some writes are done
   sleep 2

   type=$(cat $FILE|jq -r .type)
   if [ "$type" != "InvoicePaymentSettled" ]
   then 
        echo $FILE does not have a valid invoice type: [$type] expected [InvoicePaymentSettled]. Keeping control file and continuing
        continue
   fi   
 
   value=$(cat $FILE|jq -r .payment.value)

   if [ -z "$value" ] 
   then 
        echo $FILE does not have a valid invoice value: [$value]. Keeping control file and continuing
        continue
   fi
   amount=$( printf "%.0f" $(echo $value*$RATE*100000000 | bc -l))
   echo Amount: $amount

   if [ ! $amount -gt 0 ]
   then 
      echo $FILE resulting amount is not grater than 0: [$amount]. Keeping control file and continuing
      continue
   fi

   method=$(cat $FILE|jq -r .paymentMethod)

   if [ -z "$method" ] 
   then 
        echo $FILE does not have a valid paymentMethod: [$method]. Keeping control file and continuing
        continue
   fi

   if [ ! "$method" = "BTC-LightningNetwork" ] 
   then 
        echo $FILE does not have BTC-LightningNetwork payment method: [$method]. Keeping control file and continuing
        continue
   fi       

   id=$(cat $FILE|jq -r .invoiceId)

   if [ -z "$id" ] 
   then 
        echo $FILE does not have a invoice Id: [$id]. Keeping control file and continuing
        continue
   fi
    
   $EXEDIR/doit $TOKEN $amount $id
   status=$?
   if [ ! $status -eq 0 ]; then
      echo error while processing $FILE. Keeping control file and continuing
      continue
   fi   
   mv $FILE $DONEDIR/ 
   mv $i $DONEDIR/ 

done
	echo Waiting for payments
   ##Wait for a invoice to come   
   inotifywait -qq -t 60 /mnt/hdd/BTCPAYSERVER/invoices/ 


done